=head1 NAME

Sarze - An HTTP server

=head1 SYNOPSIS

XXX

=head1 DESCRIPTION

XXX

=head1 METHODS

There are following methods:

XXX

$p = $server->run (...)

Run the server and return a promise that is resolved when the server
is stopped.

XXX

$p = $server->start (...)

Run the server and return a promise that is resolved with the server
object when the server is ready to accept connections.

XXX

$p = $server->stop

Schedule the server to stop and return a promise that is resolved when
the server is stopped.

XXX

$p = $server->completed

XXX
Promise must be resolved with an object that is XXX

$object->stop

XXX

This method is invoked when the worker process is to be stopped.

$promise = $object->completed

XXX

The completed promise should be resolved when the background process
has been stopped.  When the completed promise is resolved or rejected,
the entire worker process is to be stopped.

=head1 OPTIONS

Following options can be specified to C<start> and C<run> methods:

=over 4

=item hostports => [[$host, $port], ...]

An array reference of zero or more host/port pair array references.  A
host/port pair must be either a pair of IP address and port (for TCP
socket) or a pair of string C<unix/> and path to the file (for UNIX
domain socket).

=item psgi_file_name

XXX

If the PSGI script file C<psgi_file_name> is not found, or does not
return a code reference, the promise returned by the C<start> or
C<run> method is to be rejected with an error.

If this option is specified, the C<eval> option must not be specified.

=item eval

XXX

If the code throws, or if the code does not define the
C<&main::psgi_app>, the promise returned by the C<start> or C<run>
method is to be rejected with an error.

If this option is specified, the C<psgi_file_name> option must not be
specified.

=item worker_background_class => $class

XXX

=item max_worker_count

XXX

=item connections_per_worker

XXX

=item seconds_per_worker => $seconds (default: 60*10)

After the seconds specified by this option has elapsed, a worker is
switched to the shutdowning mode, where no incoming request is
accepted anymore and any running handlers are expected to be stopped
as far as possible.

=item shutdown_timeout => $seconds (default: 60*1)

After the seconds specified by this option has elapsed from it was
switched to the shutdowning mode, a worker is uncleanly terminated
even when there is a running handler.

=back

=head1 EXECUTION

Sarze is a preforking HTTP server.  It creates worker processes which
handle coming HTTP connections.

Sarze first loads the server code (as specified by C<eval> or
C<psgi_file_name> option) and then forks that as workers.  This means
that any variable value initialized at loading is shared among the
workers executed by a server.  For example,

  ## Bad example!
  eval => q{
    my $number = rand; ## This line is executed only once.
    return sub {
      return [200, [], [$number]];
    };
  },

... always returns the same number.

=head1 SIGNALS

While the Sarze server is running, it receives signals.

When it receives one of C<SIGINT>, C<SIGTERM>, or C<SIGQUIT>, it stops
(as if the C<stop> method were invoked).

It might not immediately terminate the server when it is still in the
process of generating and sending a response.  Once it receives a
signal, it uninstalls the signal handler.  By sending the second
signal, which is processed by Perl's default handler, the entire
application exits and Sarze's graceful termination process is aborted.

=head1 DEPENDENCY

The C<Sarze> module requires Perl 5.10 or later.

It requires modules L<AnyEvnet::Socket> and L<AnyEvent::Fork>.

It also requires following Perl modules (submodules of this Git
repository): <https://github.com/wakaba/perl-promise>,
<https://github.com/manakai/perl-web-datetime>,
<https://github.com/manakai/perl-web-encodings>,
<https://github.com/manakai/perl-web-resource>, and
<https://github.com/manakai/perl-web-url>.

=head1 AVAILABILITY

This module is available as a Git repository at
<https://github.com/wakaba/sarze>.

=head1 AUTHOR

Wakaba <wakaba@suikawiki.org>.

=head1 LICENSE

Copyright 2016-2017 Wakaba <wakaba@suikawiki.org>.

This program is free software; you can redistribute it and/or modify
it under the same terms as Perl itself.

=cut
